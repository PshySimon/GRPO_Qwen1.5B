# GRPO Qwen2.5-1.5B é¡¹ç›®

åŸºäº GRPO (Group Relative Policy Optimization) ç®—æ³•å¾®è°ƒ Qwen2.5-1.5B-Instruct æ¨¡å‹è¿›è¡Œæ•°å­¦é—®é¢˜æ±‚è§£çš„é¡¹ç›®ã€‚

## âœ¨ ä¸»è¦ç‰¹æ€§

- ğŸ¯ **å®Œæ•´çš„GRPOå®ç°**: ä»å¤´å®ç°Group Relative Policy Optimizationç®—æ³•
- ğŸ“Š **è¯¦ç»†æŒ‡æ ‡è®°å½•**: è®°å½•lossã€rewardã€è¾“å‡ºé•¿åº¦ç­‰è®­ç»ƒæŒ‡æ ‡
- ğŸ“ˆ **å¯è§†åŒ–åˆ†æ**: è‡ªåŠ¨ç”Ÿæˆè®­ç»ƒè¿‡ç¨‹å›¾è¡¨å’Œç»Ÿè®¡æŠ¥å‘Š
- ğŸ”„ **æ–­ç‚¹ç»­è®­**: æ”¯æŒè®­ç»ƒä¸­æ–­åæ— ç¼ç»­è®­
- ğŸ¨ **å¥–åŠ±åˆ†è§£**: åˆ†åˆ«æ˜¾ç¤ºæ­£ç¡®æ€§å¥–åŠ±å’Œæ ¼å¼å¥–åŠ±
- ğŸ’¾ **å®éªŒç®¡ç†**: è‡ªåŠ¨ç®¡ç†å®éªŒç›®å½•å’Œæ£€æŸ¥ç‚¹

## é¡¹ç›®ç»“æ„

```
grpo_qwen_1.5b/
â”œâ”€â”€ README.md
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ training.yaml           # è®­ç»ƒé…ç½®
â”‚   â”œâ”€â”€ model.yaml             # æ¨¡å‹é…ç½®
â”‚   â”œâ”€â”€ logging.yaml           # æ—¥å¿—é…ç½®
â”‚   â””â”€â”€ resume.yaml            # æ–­ç‚¹ç»­è®­é…ç½®ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”œâ”€â”€ dataset.py         # æ•°æ®é›†å¤„ç†
â”‚   â”‚   â””â”€â”€ utils.py           # æ•°æ®ç›¸å…³å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ rewards/
â”‚   â”‚   â””â”€â”€ rewards.py         # å¥–åŠ±å‡½æ•°ï¼ˆæ­£ç¡®æ€§+æ ¼å¼ï¼‰
â”‚   â”œâ”€â”€ grpo/
â”‚   â”‚   â””â”€â”€ algorithm.py       # GRPOç®—æ³•æ ¸å¿ƒå®ç°
â”‚   â”œâ”€â”€ training/
â”‚   â”‚   â””â”€â”€ trainer.py         # å¢å¼ºè®­ç»ƒå™¨ï¼ˆæ”¯æŒæ–­ç‚¹ç»­è®­ï¼‰
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ config.py          # é…ç½®ç®¡ç†
â”‚       â”œâ”€â”€ logging.py         # æ—¥å¿—å·¥å…·
â”‚       â”œâ”€â”€ device.py          # è®¾å¤‡ç®¡ç†ï¼ˆæ”¯æŒMPSï¼‰
â”‚       â””â”€â”€ random.py          # éšæœºç§å­è®¾ç½®
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ train.py               # è®­ç»ƒè„šæœ¬ï¼ˆæ”¯æŒ--resumeï¼‰
â”‚   â”œâ”€â”€ evaluate.py            # è¯„ä¼°è„šæœ¬
â”‚   â”œâ”€â”€ test_model.py          # æµ‹è¯•å¾®è°ƒåçš„æ¨¡å‹
â”‚   â”œâ”€â”€ visualize_experiment.py # å®éªŒå¯è§†åŒ–è„šæœ¬
â”‚   â””â”€â”€ download.sh            # æ¨¡å‹å’Œæ•°æ®ä¸‹è½½è„šæœ¬
â””â”€â”€ output/
    â”œâ”€â”€ experiments/           # å®éªŒç›®å½•
    â”‚   â””â”€â”€ exp_YYYYMMDD_HHMMSS/
    â”‚       â”œâ”€â”€ checkpoints/   # æ¨¡å‹æ£€æŸ¥ç‚¹
    â”‚       â”œâ”€â”€ metrics/       # è®­ç»ƒæŒ‡æ ‡
    â”‚       â”œâ”€â”€ samples/       # æ ·æœ¬è¾“å‡º
    â”‚       â””â”€â”€ final_model/   # æœ€ç»ˆæ¨¡å‹
    â”œâ”€â”€ logs/                  # æ—¥å¿—æ–‡ä»¶
    â””â”€â”€ plots/                 # å¯è§†åŒ–å›¾è¡¨
```

## å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–
```bash
pip install -r requirements.txt
```

### 2. ä¸‹è½½æ¨¡å‹å’Œæ•°æ®ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰
```bash
# ä½¿ç”¨shellè„šæœ¬è‡ªåŠ¨ä¸‹è½½
./scripts/download.sh

# æ•°æ®é›†ä¼šè‡ªåŠ¨ç¼“å­˜åˆ° ./datasets/ ç›®å½•
# æ¨¡å‹ä¼šä¸‹è½½åˆ°é»˜è®¤ç¼“å­˜ä½ç½®
```

### 3. å¼€å§‹è®­ç»ƒ
```bash
# ä»å¤´å¼€å§‹è®­ç»ƒ
python scripts/train.py

# ä»æ–­ç‚¹ç»­è®­
python scripts/train.py --resume
```

### 4. å¯è§†åŒ–è®­ç»ƒç»“æœ
```bash
# æŸ¥çœ‹è®­ç»ƒå›¾è¡¨ï¼ˆè®­ç»ƒå®Œæˆåä¼šè‡ªåŠ¨æç¤ºå‘½ä»¤ï¼‰
python scripts/visualize_experiment.py output/experiments/exp_20241221_143022
```

### 5. è¯„ä¼°å’Œæµ‹è¯•
```bash
# è¯„ä¼°åŸå§‹æ¨¡å‹
python scripts/evaluate.py

# æµ‹è¯•å¾®è°ƒåçš„æ¨¡å‹
python scripts/test_model.py
```

## ğŸ“Š è®­ç»ƒæŒ‡æ ‡è¯´æ˜

### å¥–åŠ±ç³»ç»Ÿ
- **Correctness Reward**: 0-2.0åˆ†
  - 2.0åˆ†ï¼šç­”æ¡ˆå®Œå…¨æ­£ç¡®
  - 1.5åˆ†ï¼šæ•°å€¼æ­£ç¡®ä½†æ ¼å¼ä¸åŒ
  - 0.0åˆ†ï¼šç­”æ¡ˆé”™è¯¯
  
- **Format Reward**: 0-0.8åˆ†
  - æ¯ä¸ªXMLæ ‡ç­¾å­˜åœ¨å¾—0.2åˆ†ï¼š`<reasoning>`, `</reasoning>`, `<answer>`, `</answer>`
  
- **Combined Reward**: 0-2.8åˆ†ï¼ˆä¸¤è€…ç›¸åŠ ï¼‰

### è¾“å‡ºæŒ‡æ ‡
- **Loss**: GRPOæŸå¤±å€¼
- **Average Reward**: å¹³å‡ç»„åˆå¥–åŠ±
- **Output Length**: ç”Ÿæˆæ–‡æœ¬é•¿åº¦ç»Ÿè®¡

## é…ç½®è¯´æ˜

### è®­ç»ƒé…ç½® (config/training.yaml)
- `num_iterations`: å¤–å±‚è¿­ä»£æ¬¡æ•°
- `num_steps`: æ¯ä¸ªè¿­ä»£çš„è®­ç»ƒæ­¥æ•°
- `batch_size`: æ‰¹æ¬¡å¤§å°
- `num_generations`: æ¯ä¸ªæç¤ºç”Ÿæˆçš„å®Œæˆæ•°
- `max_completion_length`: æœ€å¤§å®Œæˆé•¿åº¦
- `beta`: KLæƒ©ç½šç³»æ•°
- `learning_rate`: å­¦ä¹ ç‡
- `mu`: æ¯ä¸ªæ‰¹æ¬¡çš„ç­–ç•¥æ›´æ–°æ¬¡æ•°
- `epsilon`: PPOè£å‰ªå‚æ•°

### æ¨¡å‹é…ç½® (config/model.yaml)
- `model_name`: é¢„è®­ç»ƒæ¨¡å‹åç§°
- `attn_implementation`: æ³¨æ„åŠ›å®ç°æ–¹å¼
- `torch_dtype`: æ•°æ®ç±»å‹
- `device_map`: è®¾å¤‡æ˜ å°„

## ğŸ”„ æ–­ç‚¹ç»­è®­åŠŸèƒ½

### è‡ªåŠ¨ä¿å­˜
- æ¯50æ­¥è‡ªåŠ¨ä¿å­˜è®­ç»ƒçŠ¶æ€åˆ° `config/resume.yaml`
- ä¿å­˜æ¨¡å‹æ£€æŸ¥ç‚¹åˆ°å®éªŒç›®å½•
- è®°å½•å½“å‰è®­ç»ƒè¿›åº¦å’Œæœ€ä½³å¥–åŠ±

### ç»­è®­ä½¿ç”¨
```bash
# æ£€æŸ¥æ˜¯å¦æœ‰æ–­ç‚¹å¯ä»¥æ¢å¤
ls config/resume.yaml

# ä»æ–­ç‚¹ç»§ç»­è®­ç»ƒ
python scripts/train.py --resume
```

### çŠ¶æ€æ¢å¤
- è‡ªåŠ¨åŠ è½½æœ€æ–°æ£€æŸ¥ç‚¹æ¨¡å‹
- æ¢å¤è®­ç»ƒè¿›åº¦ï¼ˆiteration, stepï¼‰
- ç»§ç»­è®°å½•è®­ç»ƒæŒ‡æ ‡å†å²

## ğŸ“ˆ å¯è§†åŒ–åŠŸèƒ½

è®­ç»ƒå®Œæˆåï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆä»¥ä¸‹å›¾è¡¨ï¼š

- **loss.png**: è®­ç»ƒæŸå¤±æ›²çº¿
- **reward.png**: å¥–åŠ±åˆ†è§£å›¾ï¼ˆæ­£ç¡®æ€§+æ ¼å¼+ç»„åˆï¼‰
- **output_length.png**: è¾“å‡ºé•¿åº¦ç»Ÿè®¡
- **loss_vs_reward.png**: æŸå¤±vså¥–åŠ±æ•£ç‚¹å›¾
- **training_progress.png**: è®­ç»ƒè¿›åº¦ç»¼åˆå›¾
- **summary.json**: è®­ç»ƒç»Ÿè®¡æ‘˜è¦

```bash
# æ‰‹åŠ¨ç”Ÿæˆå›¾è¡¨
python scripts/visualize_experiment.py output/experiments/exp_20241221_143022 --output_dir output/plots
```

## âš™ï¸ ç¡¬ä»¶è¦æ±‚ä¸é…ç½®

### æ¨èé…ç½®
- **GPU**: 80GB VRAMï¼ˆå¦‚A100ï¼‰
- **å†…å­˜**: 32GB+ RAM
- **å­˜å‚¨**: 50GB+ å¯ç”¨ç©ºé—´

### æ˜¾å­˜ä¼˜åŒ–
æ ¹æ®ä½ çš„ç¡¬ä»¶è°ƒæ•´ `config/training.yaml`ï¼š

```yaml
# é«˜æ˜¾å­˜é…ç½® (80GB)
batch_size: 8
num_generations: 16
max_completion_length: 512

# ä¸­ç­‰æ˜¾å­˜é…ç½® (40GB)  
batch_size: 4
num_generations: 8
max_completion_length: 400

# ä½æ˜¾å­˜é…ç½® (24GB)
batch_size: 2
num_generations: 4
max_completion_length: 256
```

### è®¾å¤‡æ”¯æŒ
- âœ… **NVIDIA GPU**: CUDAåŠ é€Ÿ
- âœ… **Apple Silicon**: MPSåŠ é€Ÿï¼ˆMac M1/M2/M3ï¼‰
- âœ… **CPU**: çº¯CPUè®­ç»ƒï¼ˆè¾ƒæ…¢ï¼‰

## ğŸ› å¸¸è§é—®é¢˜

### Q: è®­ç»ƒä¸­æ–­äº†æ€ä¹ˆåŠï¼Ÿ
A: ä½¿ç”¨ `python scripts/train.py --resume` ä»æ–­ç‚¹ç»§ç»­

### Q: æ˜¾å­˜ä¸å¤Ÿæ€ä¹ˆåŠï¼Ÿ
A: å‡å° `batch_size`ã€`num_generations` æˆ– `max_completion_length`

### Q: å¦‚ä½•æŸ¥çœ‹è®­ç»ƒè¿›åº¦ï¼Ÿ
A: è®­ç»ƒè¿‡ç¨‹ä¼šå®æ—¶æ˜¾ç¤ºæŒ‡æ ‡ï¼Œå®Œæˆåç”¨å¯è§†åŒ–è„šæœ¬æŸ¥çœ‹å›¾è¡¨

### Q: æ¨¡å‹ä¿å­˜åœ¨å“ªé‡Œï¼Ÿ
A: æœ€ç»ˆæ¨¡å‹ä¿å­˜åœ¨ `output/experiments/exp_xxx/final_model/`

## ğŸ“ å®éªŒè®°å½•

æ¯æ¬¡è®­ç»ƒéƒ½ä¼šåˆ›å»ºç‹¬ç«‹çš„å®éªŒç›®å½•ï¼š
```
output/experiments/exp_20241221_143022/
â”œâ”€â”€ experiment_config.json    # å®éªŒé…ç½®
â”œâ”€â”€ checkpoints/             # æ£€æŸ¥ç‚¹ï¼ˆæ¯50æ­¥ï¼‰
â”œâ”€â”€ metrics/                 # è®­ç»ƒæŒ‡æ ‡JSON
â”œâ”€â”€ samples/                 # æ ·æœ¬è¾“å‡ºï¼ˆæ¯10æ­¥ï¼‰
â””â”€â”€ final_model/            # æœ€ç»ˆæ¨¡å‹
```

